<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Blog - Wen ZENG</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <header>
      <nav class="navbar">
        <div class="logo">
          <a href="index.html">Wen ZENG</a>
        </div>
        <ul class="nav-links">
          <li><a href="index.html">Home</a></li>
          <li><a href="about.html">About</a></li>
          <li><a href="projects.html">Projects</a></li>
          <li><a href="blog.html">Blog</a></li>
          <li><a href="contact.html">Contact</a></li>
        </ul>
        <div class="hamburger">
          <span></span>
          <span></span>
          <span></span>
        </div>
      </nav>
    </header>

    <main>
      <section class="section-blog">
        <div class="blog-container">
          <h1>My Blog Posts</h1>
          <div class="blog-header">
            <p>
              Read my latest posts on my
              <a href="https://wen-zeng.hashnode.dev" target="_blank"
                >Hashnode blog</a
              >
            </p>
          </div>
          <div id="blog-posts" class="blog-posts-grid">
            <!-- Posts will be loaded here -->
            <div class="loading">Loading posts...</div>
          </div>
        </div>
      </section>
    </main>

    <footer>
      <p>&copy; 2024 Wen ZENG. All rights reserved.</p>
    </footer>

    <script>
      async function fetchBlogPosts() {
        const query = `
                query {
                    publication(host: "wen-zeng.hashnode.dev") {
                        isTeam
                        title
                        posts(first: 50) {
                            edges {
                                node {
                                    id
                                    title
                                    brief
                                    slug
                                    publishedAt
                                    coverImage {
                                        url
                                    }
                                }
                            }
                        }
                    }
                }
            `;

        try {
          const response = await fetch("https://gql.hashnode.com", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Cache-Control": "no-cache, no-store, must-revalidate",
              Pragma: "no-cache",
              Expires: "0",
            },
            body: JSON.stringify({ query }),
          });

          // Clear browser cache for this page
          window.location.reload(true);

          const data = await response.json();
          console.log("API Response:", data);

          const blogPostsContainer = document.getElementById("blog-posts");

          if (data.data?.publication?.posts?.edges) {
            const posts = data.data.publication.posts.edges;

            if (posts.length > 0) {
              // Sort posts by date (newest first)
              posts.sort(
                (a, b) =>
                  new Date(b.node.publishedAt) - new Date(a.node.publishedAt)
              );

              blogPostsContainer.innerHTML = posts
                .map(
                  ({ node: post }) => `
                            <article class="blog-post-card">
                                ${
                                  post.coverImage
                                    ? `<img src="${post.coverImage.url}" alt="${post.title}" class="post-cover">`
                                    : ""
                                }
                                <div class="post-content">
                                    <h2>${post.title}</h2>
                                    <div class="post-date">${new Date(
                                      post.publishedAt
                                    ).toLocaleDateString("en-US", {
                                      year: "numeric",
                                      month: "long",
                                      day: "numeric",
                                    })}</div>
                                    <p class="post-brief">${
                                      post.brief || ""
                                    }</p>
                                    <a href="https://wen-zeng.hashnode.dev/${
                                      post.slug
                                    }" target="_blank" class="read-more">Read More</a>
                                </div>
                            </article>
                        `
                )
                .join("");
            } else {
              blogPostsContainer.innerHTML = `
                            <div class="no-posts">
                                <p>No blog posts found yet. Visit my blog on 
                                    <a href="https://wen-zeng.hashnode.dev" target="_blank">Hashnode</a>
                                    to read future posts!
                                </p>
                            </div>
                        `;
            }
          } else {
            throw new Error("Unable to fetch blog posts");
          }
        } catch (error) {
          console.error("Error details:", error);
          document.getElementById("blog-posts").innerHTML = `
                    <div class="blog-redirect">
                        <p>Visit my blog directly at: 
                            <a href="https://wen-zeng.hashnode.dev" target="_blank">wen-zeng.hashnode.dev</a>
                        </p>
                    </div>
                `;
        }
      }

      // Load posts when the page loads
      fetchBlogPosts();

      // Add a refresh button
      const blogHeader = document.querySelector(".blog-header");
      const refreshButton = document.createElement("button");
      refreshButton.textContent = "Refresh Posts";
      refreshButton.className = "refresh-button";
      refreshButton.onclick = fetchBlogPosts;
      blogHeader.appendChild(refreshButton);
    </script>

    <style>
      .refresh-button {
        margin-top: 1rem;
        padding: 0.5rem 1rem;
        background-color: #333;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s;
      }

      .refresh-button:hover {
        background-color: #555;
      }
    </style>
  </body>
</html>
